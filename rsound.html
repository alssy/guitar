<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Í∏∞ÌÉÄ ÏßÄÌåê Ïó∞ÏäµÍ∏∞ - ÌôîÎ©¥ Í≥†Ï†ï & Ïπ¥Ïö¥Ìä∏Îã§Ïö¥</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body class="bg-slate-900 overflow-x-hidden text-slate-200">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const GuitarFretboardTrainer = () => {
          const baseNotes = ['C','D','E','F','G','A','B'];
          
          const getSavedValue = (key, defaultValue) => {
            const saved = localStorage.getItem(key);
            return saved !== null ? JSON.parse(saved) : defaultValue;
          };

          const [selectedNote, setSelectedNote] = useState(() => baseNotes[Math.floor(Math.random() * baseNotes.length)]);
          const [accidental, setAccidental] = useState('');
          const [isRandomAccidental, setIsRandomAccidental] = useState(false);
          const [isPreview, setIsPreview] = useState(true);
          const [bpm, setBpm] = useState(() => getSavedValue('guitar-trainer-bpm', 40));
          const [duration, setDuration] = useState(() => getSavedValue('guitar-trainer-duration', 3));
          const [isPlaying, setIsPlaying] = useState(false);
          const [isPaused, setIsPaused] = useState(false);
          const [currentString, setCurrentString] = useState(null);
          const [currentFret, setCurrentFret] = useState(null);
          const [timeRemaining, setTimeRemaining] = useState(0);
          const [isLoaded, setIsLoaded] = useState(false);
          
          const samplerRef = useRef(null);
          const metronomeRef = useRef(null);
          const loopRef = useRef(null);
          const beatCountRef = useRef(0);
          const intervalRef = useRef(null);
          const stopRequestedRef = useRef(false);
          const wakeLockRef = useRef(null); // üî• ÌôîÎ©¥ Í≥†Ï†ïÏö© Ref

          const isPlayingRef = useRef(isPlaying);
          const isPausedRef = useRef(isPaused);
          const isLoadedRef = useRef(isLoaded);
          const configRef = useRef({ selectedNote, accidental, bpm, duration });

          useEffect(() => {
            localStorage.setItem('guitar-trainer-bpm', JSON.stringify(bpm));
          }, [bpm]);

          useEffect(() => {
            localStorage.setItem('guitar-trainer-duration', JSON.stringify(duration));
          }, [duration]);

          useEffect(() => {
            isPlayingRef.current = isPlaying;
            isPausedRef.current = isPaused;
            isLoadedRef.current = isLoaded;
            configRef.current = { selectedNote, accidental, bpm, duration };
          }, [isPlaying, isPaused, isLoaded, selectedNote, accidental, bpm, duration]);

          // üî• ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ Ìï®Ïàò
          const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
              try {
                wakeLockRef.current = await navigator.wakeLock.request('screen');
              } catch (err) {
                console.log("Wake Lock request failed");
              }
            }
          };

          const releaseWakeLock = () => {
            if (wakeLockRef.current !== null) {
              wakeLockRef.current.release();
              wakeLockRef.current = null;
            }
          };

          const stringNotes = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2']; 
          const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
          const notesFlat = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

          useEffect(() => {
            samplerRef.current = new Tone.Sampler({
              urls: { "A2": "A2.mp3", "C4": "C4.mp3", "A4": "A4.mp3" },
              baseUrl: "https://tonejs.github.io/audio/salamander/",
              onload: () => setIsLoaded(true)
            }).toDestination();
            samplerRef.current.release = 0.4;

            metronomeRef.current = new Tone.MembraneSynth({
              pitchDecay: 0.008, octaves: 2,
              envelope: { attack: 0.0001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            metronomeRef.current.volume.value = -6;

            return () => { stopPractice(); samplerRef.current?.dispose(); metronomeRef.current?.dispose(); };
          }, []);

          const isSharpDisabled = (note) => note === 'E' || note === 'B';
          const isFlatDisabled = (note) => note === 'F' || note === 'C';

          const handleNoteSelect = (n) => {
            if (isPlayingRef.current) return;
            setSelectedNote(n);
            if (accidental === '#' && isSharpDisabled(n)) setAccidental('');
            if (accidental === 'b' && isFlatDisabled(n)) setAccidental('');
          };

          const handleShuffle = () => {
            const currentNote = configRef.current.selectedNote;
            const filteredNotes = baseNotes.filter(n => n !== currentNote);
            const nextNote = filteredNotes[Math.floor(Math.random() * filteredNotes.length)];
            let nextAcc = '';
            if (isRandomAccidental) {
              let validAccs = [''];
              if (!isSharpDisabled(nextNote)) validAccs.push('#');
              if (!isFlatDisabled(nextNote)) validAccs.push('b');
              nextAcc = validAccs[Math.floor(Math.random() * validAccs.length)];
            } else {
              nextAcc = configRef.current.accidental;
            }
            setSelectedNote(nextNote);
            setAccidental(nextAcc);
          };

          const toggleRandomAccidental = () => {
            if (isPlaying) return;
            const nextState = !isRandomAccidental;
            setIsRandomAccidental(nextState);
            if (!nextState) setAccidental('');
          };

          const getNoteFromFret = (stringIndex, fret) => {
            const baseNote = stringNotes[stringIndex];
            const noteName = baseNote.slice(0, -1);
            const octave = parseInt(baseNote.slice(-1));
            const noteIndex = notes.indexOf(noteName);
            const newNoteIndex = (noteIndex + fret) % 12;
            const octaveShift = Math.floor((noteIndex + fret) / 12);
            return notes[newNoteIndex] + (octave + octaveShift);
          };

          const startPractice = async () => {
            if (!isLoadedRef.current) return;
            await Tone.start();
            await requestWakeLock(); // üî• ÌôîÎ©¥ Í≥†Ï†ï ÏãúÏûë
            
            setIsPlaying(true); setIsPaused(false); stopRequestedRef.current = false;
            setTimeRemaining(configRef.current.duration * 60); 
            beatCountRef.current = 0;
            const targetName = configRef.current.selectedNote + configRef.current.accidental;
            const stringPattern = [6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6]; 
            let patternStep = 0;
            Tone.Transport.bpm.value = configRef.current.bpm;

            loopRef.current = new Tone.Loop((time) => {
              beatCountRef.current++;
              
              if (beatCountRef.current <= 4) {
                metronomeRef.current.triggerAttackRelease('C5', '32n', time);
                return;
              }

              if (beatCountRef.current === 5) Tone.Draw.schedule(() => startTimer(), time);
              
              const currentStringNum = stringPattern[patternStep];
              const stringIdx = 6 - currentStringNum; 
              let targetFret = -1;
              for (let f = 1; f <= 12; f++) {
                const noteWithOctave = getNoteFromFret(stringIdx, f);
                const nName = noteWithOctave.slice(0, -1);
                if (nName === targetName || notesFlat[notes.indexOf(nName)] === targetName) {
                  targetFret = f;
                  break;
                }
              }

              Tone.Draw.schedule(() => {
                setCurrentString(stringIdx);
                setCurrentFret(targetFret);
              }, time);
              
              if (targetFret !== -1) {
                samplerRef.current.triggerAttackRelease(getNoteFromFret(stringIdx, targetFret), '0.8', time);
              }

              if (stopRequestedRef.current && patternStep === stringPattern.length - 1) { 
                Tone.Draw.schedule(() => stopPractice(), time + 0.5); 
              }
              patternStep = (patternStep + 1) % stringPattern.length;
            }, '4n').start(0);
            Tone.Transport.start();
          };

          const pausePractice = () => { Tone.Transport.pause(); if (intervalRef.current) clearInterval(intervalRef.current); setIsPaused(true); };
          const resumePractice = () => { Tone.Transport.start(); startTimer(); setIsPaused(false); };
          
          const stopPractice = () => {
            Tone.Transport.stop();
            if (loopRef.current) { loopRef.current.stop(); loopRef.current = null; }
            if (intervalRef.current) clearInterval(intervalRef.current);
            setIsPlaying(false); setIsPaused(false); setCurrentString(null); setCurrentFret(null);
            stopRequestedRef.current = false;
            releaseWakeLock(); // üî• ÌôîÎ©¥ Í≥†Ï†ï Ìï¥Ï†ú
            handleShuffle(); 
          };

          const startTimer = () => {
            if (intervalRef.current) clearInterval(intervalRef.current);
            intervalRef.current = setInterval(() => {
              setTimeRemaining(prev => {
                if (prev <= 1) { clearInterval(intervalRef.current); stopRequestedRef.current = true; return 0; }
                return prev - 1;
              });
            }, 1000);
          };

          useEffect(() => {
            const handleKeyDown = (e) => {
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
              if (e.code === 'Space') {
                e.preventDefault();
                if (!isPlayingRef.current) {
                    if (isLoadedRef.current) startPractice();
                } else {
                    isPausedRef.current ? resumePractice() : pausePractice();
                }
              }
            };
            window.addEventListener('keydown', handleKeyDown);
            // Í∞ÄÏãúÏÑ± Î≥ÄÍ≤Ω Ïãú Ïû¨ÏöîÏ≤≠ (Î™®Î∞îÏùº ÎåÄÏùë)
            const handleVisibilityChange = () => {
                if (document.visibilityState === 'visible' && isPlayingRef.current) requestWakeLock();
            };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            return () => {
                window.removeEventListener('keydown', handleKeyDown);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
            };
          }, []);

          return (
            <div className="min-h-screen p-4 md:p-8 font-sans touch-none select-none">
              <div className="max-w-5xl mx-auto">
                {/* Ìó§Îçî Î∞è ÌÉÄÏù¥Î®∏ UI */}
                <div className="flex justify-between items-center mb-6">
                    <div className="flex flex-col">
                        <h1 className="text-xl font-black text-slate-500 italic uppercase tracking-tighter">Fretboard Trainer</h1>
                        <span className="text-[10px] text-slate-600 font-bold uppercase mt-1">[Space] Start/Pause</span>
                    </div>
                    {isPlaying && (
                        <div className="bg-slate-800 px-4 py-1 rounded-full border border-slate-700 font-mono text-xl font-bold text-blue-400">
                            {stopRequestedRef.current ? "FINISHING..." : `${Math.floor(timeRemaining / 60)}:${String(timeRemaining % 60).padStart(2, '0')}`}
                        </div>
                    )}
                </div>
                
                {/* ÏÑ§Ï†ï Ìå®ÎÑê */}
                <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl mb-8 border border-slate-700">
                  <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                    <div className={`md:col-span-3 flex justify-center md:justify-start transition-all duration-300 ${isPlaying ? 'opacity-30 pointer-events-none grayscale' : 'opacity-100'}`}>
                      <div className="grid grid-cols-5 gap-1.5 w-fit">
                        {baseNotes.map(n => (
                          <button key={n} onClick={() => handleNoteSelect(n)} className={`w-10 h-10 rounded-lg font-bold transition-all ${selectedNote === n ? 'bg-blue-600 text-white ring-2 ring-blue-400' : 'bg-slate-700 hover:bg-slate-600'}`}>{n}</button>
                        ))}
                        <button disabled={isSharpDisabled(selectedNote)} onClick={() => setAccidental(accidental === '#' ? '' : '#')} className={`w-10 h-10 rounded-lg font-bold transition-all ${accidental === '#' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'} ${isSharpDisabled(selectedNote) ? 'opacity-20 cursor-not-allowed scale-90' : 'opacity-100'}`}>#</button>
                        <button disabled={isFlatDisabled(selectedNote)} onClick={() => setAccidental(accidental === 'b' ? '' : 'b')} className={`w-10 h-10 rounded-lg font-bold transition-all ${accidental === 'b' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'} ${isFlatDisabled(selectedNote) ? 'opacity-20 cursor-not-allowed scale-90' : 'opacity-100'}`}>‚ô≠</button>
                        <button onClick={handleShuffle} className="w-10 h-10 rounded-lg flex items-center justify-center bg-indigo-600 text-white active:scale-95"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg></button>
                      </div>
                    </div>
                    <div className="md:col-span-9 grid grid-cols-2 md:grid-cols-5 gap-3">
                      <button onClick={toggleRandomAccidental} disabled={isPlaying} className={`rounded-xl text-[11px] font-black border py-3 transition-all ${isPlaying ? 'opacity-30 grayscale' : 'opacity-100'} ${isRandomAccidental ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-slate-900 border-slate-700 text-slate-600'}`}>RAND<br/>ACC</button>
                      <button onClick={() => setIsPreview(!isPreview)} className={`rounded-xl text-[11px] font-black border py-3 transition-all ${isPreview ? 'bg-blue-600 border-blue-400 text-white shadow-lg' : 'bg-slate-900 border-slate-700 text-slate-600'}`}>PREV<br/>{isPreview ? 'ON' : 'OFF'}</button>
                      <div className={`md:col-span-1 transition-all ${isPlaying ? 'opacity-30 grayscale pointer-events-none' : ''}`}><input type="number" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} disabled={isPlaying} className="w-full h-full bg-slate-900 p-3 rounded-xl text-center font-mono font-bold text-blue-400 border border-slate-700 outline-none" /></div>
                      <div className={`md:col-span-1 transition-all ${isPlaying ? 'opacity-30 grayscale pointer-events-none' : ''}`}><select value={duration} onChange={(e) => setDuration(Number(e.target.value))} disabled={isPlaying} className="w-full h-full bg-slate-700 p-3 rounded-xl font-bold text-sm outline-none cursor-pointer">{[1,2,3,4,5,10].map(m => <option key={m} value={m}>{m} MIN</option>)}</select></div>
                      <div className="col-span-2 md:col-span-1 flex gap-2">
                        {!isPlaying ? (<button onClick={startPractice} disabled={!isLoaded} className={`w-full rounded-xl font-black transition-all shadow-lg text-white text-lg ${isLoaded ? 'bg-blue-600 hover:bg-blue-500' : 'bg-slate-700 opacity-50'}`}>START</button>) : (
                          <div className="flex gap-2 w-full"><button onClick={isPaused ? resumePractice : pausePractice} className={`flex-[1.5] py-3 rounded-xl font-black ${isPaused ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-white'}`}>{isPaused ? 'RESUME' : 'PAUSE'}</button><button onClick={stopPractice} className="flex-1 bg-red-500 py-3 rounded-xl font-black text-white text-[10px]">STOP</button></div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* ÏßÄÌåê UI */}
                <div className="bg-slate-800 p-4 md:p-8 rounded-3xl border border-slate-700 shadow-inner relative overflow-hidden">
                  {isPaused && <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-[2px] z-30 flex items-center justify-center rounded-3xl"><span className="text-4xl font-black text-yellow-500 tracking-widest animate-pulse italic uppercase">Paused</span></div>}
                  <div className="relative pl-6 pr-2">
                    {[0, 1, 2, 3, 4, 5].map((stringIdx) => (
                      <div key={stringIdx} className="relative h-12 flex items-center">
                        <div className="absolute left-[-24px] w-6 text-[10px] font-bold text-slate-600">{stringIdx + 1}</div> 
                        <div className="flex-1 relative bg-slate-700/40 z-0" style={{ height: `${1 + stringIdx * 0.5}px` }}>
                          {[...Array(12)].map((_, idx) => {
                            const fret = idx + 1;
                            const isCurrent = currentString === stringIdx && currentFret === fret;
                            const noteName = getNoteFromFret(stringIdx, fret).slice(0,-1);
                            const targetName = selectedNote + accidental;
                            const isTarget = noteName === targetName || notesFlat[notes.indexOf(noteName)] === targetName;
                            const shouldShow = (isPreview || isCurrent) && isTarget;
                            const fretWidth = 100 / 12;
                            const centerPos = (idx * fretWidth) + (fretWidth / 2);
                            return (
                              <React.Fragment key={fret}>
                                <div className="h-12 w-[2px] bg-slate-700/50 absolute top-[-24px] z-0" style={{left: `${(idx + 1) * fretWidth}%`}}></div>
                                {shouldShow && (
                                  <div className={`w-9 h-9 rounded-full flex items-center justify-center absolute top-1/2 -translate-x-1/2 -translate-y-1/2 transition-all duration-150 z-20 
                                    ${isCurrent ? 'bg-yellow-400 text-black scale-110 font-black shadow-[0_0_20px_rgba(250,204,21,0.8)]' : 'bg-slate-800 text-slate-500/30 font-bold border border-slate-700'}`}
                                    style={{left: `${centerPos}%`}}>
                                    {fret}
                                  </div>
                                )}
                              </React.Fragment>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                    <div className="h-full w-1.5 bg-slate-400 absolute left-0 top-0 rounded-full opacity-60"></div>
                    <div className="flex mt-4 border-t border-slate-700/50 pt-2 relative">
                      {[...Array(12)].map((_, i) => (
                        <div key={i} className="flex-1 text-center text-[10px] font-black text-slate-500">{i + 1}</div>
                      ))}
                    </div>
                  </div>
                </div>
                
                {/* ÌïòÎã® ÌòÑÏû¨ ÌÉÄÍ≤ü Ï†ïÎ≥¥ */}
                <div className="mt-8 text-center">
                    <div className="inline-flex items-center gap-4 bg-slate-800/80 px-8 py-3 rounded-2xl border border-slate-700 shadow-xl transition-all">
                        {!isPlaying && <span className="text-xs font-bold text-slate-500 uppercase tracking-widest animate-pulse">Next Target</span>}
                        <span className={`font-black text-blue-400 drop-shadow-[0_0_10px_rgba(96,165,250,0.5)] transition-all ${isPlaying ? 'text-6xl px-4' : 'text-4xl'}`}>
                            {selectedNote}{accidental}
                        </span>
                    </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<GuitarFretboardTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
