<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythmic Guitar Pattern Player</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #1a1a1a; color: white; }
        .display { font-size: 3rem; margin-bottom: 20px; font-weight: bold; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
        button { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; background: #00ffcc; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #00ccaa; transform: scale(1.05); }
        button:disabled { background: #666; cursor: not-allowed; }
        .status { margin-top: 20px; color: #888; }
        .loading { color: #ffcc00; }
    </style>
</head>
<body>

    <div class="display" id="visualizer">READY</div>
    <button onclick="startSequence()" id="playBtn">PLAY SEQUENCE</button>
    <div class="status" id="status-text">프리비트 4번 후 패턴이 시작됩니다.</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const visualizer = document.getElementById('visualizer');
        const statusText = document.getElementById('status-text');
        const playBtn = document.getElementById('playBtn');

        // 기타 줄별 베이스 음
        const stringBaseNotes = { 6: 'E2', 5: 'A2', 4: 'D3', 3: 'G3', 2: 'B3', 1: 'E4' };
        
        let sampler = null;
        let isLoading = true;

        // Tone.js 샘플러 초기화 - 실제 기타 샘플 사용
        async function initSampler() {
            statusText.innerText = "기타 샘플 로딩 중...";
            statusText.className = "status loading";
            playBtn.disabled = true;

            try {
                // Tone.js의 내장 샘플러 사용
                sampler = new Tone.Sampler({
                    urls: {
                        "A2": "A2.mp3",
                        "A3": "A3.mp3",
                        "A4": "A4.mp3",
                        "C3": "C3.mp3",
                        "C4": "C4.mp3",
                        "C5": "C5.mp3",
                        "E2": "E2.mp3",
                        "E3": "E3.mp3",
                        "E4": "E4.mp3",
                    },
                    release: 1.5,
                    baseUrl: "https://tonejs.github.io/audio/salamander/",
                    onload: () => {
                        isLoading = false;
                        statusText.innerText = "준비 완료! 프리비트 4번 후 패턴이 시작됩니다.";
                        statusText.className = "status";
                        playBtn.disabled = false;
                        visualizer.innerText = "READY ✓";
                    }
                }).toDestination();

            } catch (error) {
                console.error("샘플 로딩 실패:", error);
                statusText.innerText = "샘플 로딩 실패. 합성음으로 전환합니다.";
                isLoading = false;
                playBtn.disabled = false;
            }
        }

        // 드럼 비트 (Tone.js 사용)
        function playDrumBeat(time) {
            const noise = new Tone.Noise("white").start(time).stop(time + 0.1);
            const filter = new Tone.Filter(800, "lowpass").toDestination();
            const envelope = new Tone.AmplitudeEnvelope({
                attack: 0.001,
                decay: 0.1,
                sustain: 0,
                release: 0.1
            }).toDestination();
            
            noise.connect(filter);
            filter.connect(envelope);
            envelope.triggerAttackRelease(0.1, time);
        }

        // 메인 실행부
        async function startSequence() {
            if (isLoading) return;

            await Tone.start();
            
            // 타임라인 시작
            const now = Tone.now();
            let currentTime = now + 0.2;

            // 1. 드럼 프리비트 4회
            for (let i = 0; i < 4; i++) {
                const beatTime = currentTime + i * 0.5;
                playDrumBeat(beatTime);
                
                Tone.Transport.scheduleOnce(() => {
                    visualizer.innerText = `BEAT ${i + 1}`;
                    statusText.innerText = "Drumming...";
                }, beatTime);
            }

            // 2. 6-5-4-3-2-1-1-2-3-4-5-6 패턴
            const pattern = [6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6];
            let playCursor = currentTime + 2.0;

            pattern.forEach((stringNum, index) => {
                const noteName = stringBaseNotes[stringNum];
                const noteTime = playCursor + index * 0.4;

                // 실제 기타 샘플 재생
                if (sampler) {
                    sampler.triggerAttackRelease(noteName, "2n", noteTime, 0.8);
                }

                Tone.Transport.scheduleOnce(() => {
                    visualizer.innerText = stringNum;
                    statusText.innerText = `Playing String ${stringNum} (${noteName})`;
                    
                    if (index === pattern.length - 1) {
                        setTimeout(() => {
                            visualizer.innerText = "COMPLETE ✓";
                            statusText.innerText = "다시 시작하려면 버튼을 누르세요.";
                        }, 1000);
                    }
                }, noteTime);
            });

            Tone.Transport.start();
        }

        // 페이지 로드 시 샘플러 초기화
        window.addEventListener('load', initSampler);
    </script>
</body>
</html>
