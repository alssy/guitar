<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythmic Guitar Pattern Player</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #1a1a1a; color: white; }
        .display { font-size: 3rem; margin-bottom: 20px; font-weight: bold; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
        button { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; background: #00ffcc; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #00ccaa; transform: scale(1.05); }
        .status { margin-top: 20px; color: #888; }
    </style>
</head>
<body>

    <div class="display" id="visualizer">READY</div>
    <button onclick="startSequence()">PLAY SEQUENCE</button>
    <div class="status" id="status-text">프리비트 4번 후 패턴이 시작됩니다.</div>

    <script>
        let audioCtx;
        const visualizer = document.getElementById('visualizer');
        const statusText = document.getElementById('status-text');

        // 1. 음높이 데이터
        const noteOffsets = { 'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11 };
        const stringOpenNotes = { 6: 40, 5: 45, 4: 50, 3: 55, 2: 59, 1: 64 };
        const stringBaseNotes = { 6: 'E', 5: 'A', 4: 'D', 3: 'G', 2: 'B', 1: 'E' };

        // [기타 사운드 합성]
        function playGuitarSound(noteName, stringNum, time) {
            const noteOnly = noteName.replace(/[0-9]/g, '');
            const targetOffset = noteOffsets[noteOnly];
            const openNote = stringOpenNotes[stringNum];

            let targetMidi = Math.floor(openNote / 12) * 12 + targetOffset;
            if (targetMidi < openNote) targetMidi += 12;

            const freq = 440 * Math.pow(2, (targetMidi - 69) / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(freq, time);

            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 1.2);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(time);
            osc.stop(time + 1.2);
        }

        // [드럼 프리비트 합성]
        function playDrumBeat(time) {
            const noise = audioCtx.createBufferSource();
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, time);

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.6, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);

            noise.buffer = buffer;
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start(time);
        }

        // [메인 실행부]
        async function startSequence() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            let startTime = audioCtx.currentTime + 0.2;

            // 1. 드럼 프리비트 4회 (6-5-4-3-2-1 직전 분위기 고조)
            for (let i = 0; i < 4; i++) {
                const beatTime = startTime + i * 0.5;
                playDrumBeat(beatTime);
                setTimeout(() => {
                    visualizer.innerText = `BEAT ${i + 1}`;
                    statusText.innerText = "Drumming...";
                }, (beatTime - audioCtx.currentTime) * 1000);
            }

            // 2. 6-5-4-3-2-1-1-2-3-4-5-6 패턴 구성
            const pattern = [6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6];
            let playCursor = startTime + 2.0;

            pattern.forEach((stringNum, index) => {
                const noteName = stringBaseNotes[stringNum];
                const noteTime = playCursor + index * 0.4;

                playGuitarSound(noteName, stringNum, noteTime);

                setTimeout(() => {
                    visualizer.innerText = stringNum;
                    statusText.innerText = `Playing String ${stringNum} (${noteName})`;
                    if (index === pattern.length - 1) {
                        setTimeout(() => { 
                            visualizer.innerText = "COMPLETE"; 
                            statusText.innerText = "다시 시작하려면 버튼을 누르세요.";
                        }, 1000);
                    }
                }, (noteTime - audioCtx.currentTime) * 1000);
            });
        }
    </script>
</body>
</html>
