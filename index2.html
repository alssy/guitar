<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기타 지판 연습기 - 리듬 & 진행바 모드</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const GuitarFretboardTrainer = () => {
          const [selectedNote, setSelectedNote] = useState('C');
          const [useSharp, setUseSharp] = useState(false);
          const [useFlat, setUseFlat] = useState(false);
          const [bpm, setBpm] = useState(60);
          const [duration, setDuration] = useState(1);
          const [isPlaying, setIsPlaying] = useState(false);
          const [currentString, setCurrentString] = useState(null);
          const [currentFret, setCurrentFret] = useState(null);
          const [timeRemaining, setTimeRemaining] = useState(0);
          
          const synthRef = useRef(null);
          const clickRef = useRef(null);
          const loopRef = useRef(null);
          const beatCountRef = useRef(0);
          const intervalRef = useRef(null);

          const stringNotes = ['E2', 'A2', 'D3', 'G3', 'B3', 'E4']; 
          const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
          const notesFlat = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

          useEffect(() => {
            synthRef.current = new Tone.PolySynth(Tone.Synth, {
              oscillator: { type: 'triangle' },
              envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
            clickRef.current = new Tone.MembraneSynth().toDestination();
            return () => [synthRef.current, clickRef.current, loopRef.current].forEach(ref => ref?.dispose());
          }, []);

          const getNoteFromFret = (stringIndex, fret) => {
            const baseNote = stringNotes[stringIndex];
            const noteName = baseNote.slice(0, -1);
            const octave = parseInt(baseNote.slice(-1));
            const noteIndex = notes.indexOf(noteName);
            const newNoteIndex = (noteIndex + fret) % 12;
            const octaveShift = Math.floor((noteIndex + fret) / 12);
            return notes[newNoteIndex] + (octave + octaveShift);
          };

          const getTargetNoteName = () => {
            let target = selectedNote;
            if (useSharp && !selectedNote.includes('#') && !['E', 'B'].includes(selectedNote)) {
                target = notes[(notes.indexOf(selectedNote) + 1) % 12];
            } else if (useFlat && !selectedNote.includes('b') && !['F', 'C'].includes(selectedNote)) {
                target = notes[(notes.indexOf(selectedNote) + 11) % 12];
            }
            return target;
          };

          const startPractice = async () => {
            await Tone.start();
            setIsPlaying(true);
            setTimeRemaining(duration * 60);
            beatCountRef.current = 0;
            
            const targetNoteName = getTargetNoteName();
            const stringPattern = [6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6]; 
            let patternStep = 0;

            Tone.Transport.bpm.value = bpm;
            
            loopRef.current = new Tone.Loop((time) => {
              beatCountRef.current++;
              
              if (beatCountRef.current <= 4) {
                clickRef.current.triggerAttackRelease('G2', '32n', time, 0.4);
                return;
              }

              const currentStringNum = stringPattern[patternStep];
              const stringIdx = currentStringNum - 1;
              
              let foundFret = -1;
              for (let f = 12; f >= 1; f--) { // 12프렛 우선 탐색
                const noteWithOctave = getNoteFromFret(stringIdx, f);
                if (noteWithOctave.slice(0, -1) === targetNoteName || notesFlat[notes.indexOf(noteWithOctave.slice(0, -1))] === targetNoteName) {
                  foundFret = f;
                  Tone.Draw.schedule(() => { setCurrentString(stringIdx); setCurrentFret(f); }, time);
                  synthRef.current.triggerAttackRelease(noteWithOctave, '8n', time);
                  break;
                }
              }

              if (foundFret === -1) { // 12프렛에 없으면 개방현 확인
                const openNote = getNoteFromFret(stringIdx, 0);
                if (openNote.slice(0, -1) === targetNoteName) {
                    Tone.Draw.schedule(() => { setCurrentString(stringIdx); setCurrentFret(0); }, time);
                    synthRef.current.triggerAttackRelease(openNote, '8n', time);
                }
              }

              patternStep = (patternStep + 1) % stringPattern.length;
            }, '4n').start(0);
            
            Tone.Transport.start();
            
            intervalRef.current = setInterval(() => {
              setTimeRemaining(prev => {
                if (prev <= 1) { stopPractice(); return 0; }
                return prev - 1;
              });
            }, 1000);
          };

          const stopPractice = () => {
            Tone.Transport.stop();
            if (loopRef.current) loopRef.current.stop();
            clearInterval(intervalRef.current);
            setIsPlaying(false);
            setCurrentString(null);
            setCurrentFret(null);
            beatCountRef.current = 0;
          };

          const targetNoteDisplay = getTargetNoteName();

          return (
            <div className="min-h-screen bg-slate-900 text-white p-8">
              <div className="max-w-5xl mx-auto">
                <h1 className="text-3xl font-bold mb-8 text-center text-blue-400">기타 지판 연습기 (12프렛 타겟)</h1>
                
                <div className="bg-slate-800 p-6 rounded-xl shadow-2xl mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 border border-slate-700">
                  <div>
                    <label className="block text-sm font-medium mb-2">음 선택</label>
                    <div className="flex flex-wrap gap-1">
                      {['C','D','E','F','G','A','B'].map(n => (
                        <button key={n} onClick={() => setSelectedNote(n)} 
                          className={`w-10 h-10 rounded font-bold ${selectedNote === n ? 'bg-blue-500 text-white shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'bg-slate-700 hover:bg-slate-600'}`}>{n}</button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">변화표</label>
                    <div className="flex gap-2">
                      <button onClick={() => {setUseSharp(!useSharp); setUseFlat(false)}} className={`px-4 py-2 rounded font-bold transition ${useSharp ? 'bg-green-600' : 'bg-slate-700'}`}>#</button>
                      <button onClick={() => {setUseFlat(!useFlat); setUseSharp(false)}} className={`px-4 py-2 rounded font-bold transition ${useFlat ? 'bg-green-600' : 'bg-slate-700'}`}>♭</button>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">BPM: {bpm}</label>
                    <input type="range" min="40" max="180" value={bpm} onChange={(e) => setBpm(e.target.value)} className="w-full accent-blue-500" />
                  </div>
                  <div className="flex items-end">
                    <button onClick={isPlaying ? stopPractice : startPractice} 
                      className={`w-full py-3 rounded-lg font-bold text-xl transition-all duration-300 ${isPlaying ? 'bg-red-500 hover:bg-red-600 shadow-lg' : 'bg-blue-600 hover:bg-blue-500 shadow-lg'}`}>
                      {isPlaying ? 'STOP' : 'START'}
                    </button>
                  </div>
                </div>

                {/* ⏱ 진행 상태 바 (복구됨) */}
                {isPlaying && (
                  <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8 animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                      <span className="text-blue-400 font-bold tracking-widest uppercase">Practice Progress</span>
                      <span className="text-2xl font-mono text-white">
                        {Math.floor(timeRemaining / 60)}:{String(timeRemaining % 60).padStart(2, '0')}
                      </span>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-4 overflow-hidden border border-slate-600 shadow-inner">
                      <div 
                        className="bg-gradient-to-r from-blue-600 via-blue-400 to-cyan-400 h-full transition-all duration-1000 ease-linear shadow-[0_0_15px_rgba(59,130,246,0.6)]"
                        style={{ width: `${(timeRemaining / (duration * 60)) * 100}%` }}
                      ></div>
                    </div>
                  </div>
                )}

                <div className="bg-slate-800 p-8 rounded-xl overflow-x-auto border border-slate-700 shadow-2xl relative">
                  <div className="min-w-[800px]">
                    {[...Array(6)].map((_, i) => {
                      const stringIdx = 5 - i; 
                      return (
                        <div key={stringIdx} className="relative h-14 flex items-center">
                          <div className="w-16 font-bold text-slate-500 text-sm uppercase">{stringIdx + 1} String</div>
                          <div className="flex-1 h-[3px] bg-slate-600 relative mx-4">
                            {[...Array(13)].map((_, fret) => {
                              const isCurrent = currentString === stringIdx && currentFret === fret;
                              const noteName = getNoteFromFret(stringIdx, fret).slice(0,-1);
                              const isTarget = noteName === targetNoteDisplay || notesFlat[notes.indexOf(noteName)] === targetNoteDisplay;
                              return (
                                <div key={fret} className="absolute top-1/2 -translate-y-1/2" style={{left: `${(fret/12)*100}%`}}>
                                  {isTarget && (
                                    <div className={`w-9 h-9 rounded-full flex items-center justify-center -translate-x-1/2 transition-all duration-200 shadow-xl
                                      ${isCurrent ? 'bg-yellow-400 text-black scale-125 z-10 font-black shadow-yellow-400/50' : 'bg-slate-700 text-slate-400 border border-slate-500 font-bold opacity-60'}`}>
                                      {fret}
                                    </div>
                                  )}
                                  <div className={`h-10 w-[2px] absolute -translate-x-1/2 mt-5 ${[3,5,7,9,12].includes(fret) ? 'bg-slate-400' : 'bg-slate-700/50'}`}></div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )
                    })}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<GuitarFretboardTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
